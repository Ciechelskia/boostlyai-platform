<!DOCTYPE html>
<html lang="fr">
<head>
    <base href="./">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="KINESIA - Nouvelle consultation">
  <meta name="theme-color" content="#0EA5E9">
  
  <title>Nouvelle Consultation - KINESIA</title>
  
  <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">
  
  <!-- CSS -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/components.css">
  
  <style>
    body {
      background: var(--bg-secondary);
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: var(--space-2xl);
    }
    
    .page-header {
      margin-bottom: var(--space-2xl);
    }
    
    .page-header h1 {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-sm);
    }
    
    .page-header p {
      color: var(--text-secondary);
    }
    
    /* MODE SELECTOR */
    .mode-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-lg);
      margin-bottom: var(--space-2xl);
    }
    
    .mode-card {
      background: white;
      border-radius: var(--border-radius-xl);
      padding: var(--space-2xl);
      cursor: pointer;
      border: 3px solid var(--border-color);
      transition: all var(--transition-normal);
      text-align: center;
    }
    
    .mode-card:hover {
      border-color: var(--primary);
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .mode-card.active {
      border-color: var(--primary);
      background: var(--gradient-subtle);
    }
    
    .mode-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto var(--space-lg);
      background: var(--gradient-primary);
      border-radius: var(--border-radius-xl);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .mode-icon svg {
      width: 40px;
      height: 40px;
      stroke: white;
    }
    
    .mode-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-sm);
    }
    
    .mode-desc {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }
    
    /* FORMS */
    .form-section {
      background: white;
      border-radius: var(--border-radius-xl);
      padding: var(--space-2xl);
      margin-bottom: var(--space-xl);
    }
    
    .form-section.hidden {
      display: none;
    }
    
    /* UPLOAD ZONE */
    .upload-zone {
      border: 3px dashed var(--border-color);
      border-radius: var(--border-radius-xl);
      padding: var(--space-3xl);
      text-align: center;
      background: var(--gradient-subtle);
      cursor: pointer;
      transition: all var(--transition-normal);
      margin-bottom: var(--space-xl);
    }
    
    .upload-zone:hover,
    .upload-zone.drag-over {
      border-color: var(--primary);
      background: var(--bg-tertiary);
    }
    
    .upload-icon {
      font-size: 64px;
      margin-bottom: var(--space-lg);
    }
    
    .upload-text h3 {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-sm);
    }
    
    .upload-text p {
      color: var(--text-secondary);
      margin-bottom: var(--space-lg);
    }
    
    .file-info {
      background: var(--bg-secondary);
      padding: var(--space-md);
      border-radius: var(--border-radius-md);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-lg);
    }
    
    .file-info.hidden {
      display: none;
    }
    
    .file-details {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }
    
    /* RECORDER */
    .recorder-zone {
      text-align: center;
      padding: var(--space-3xl);
    }
    
    .recorder-button {
      width: 120px;
      height: 120px;
      border-radius: var(--border-radius-full);
      background: var(--gradient-primary);
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-normal);
      margin-bottom: var(--space-xl);
      box-shadow: var(--shadow-lg);
    }
    
    .recorder-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-primary);
    }
    
    .recorder-button.recording {
      background: var(--error);
      animation: pulse 1.5s infinite;
    }
    
    .recorder-button svg {
      width: 48px;
      height: 48px;
      stroke: white;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .recording-timer {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      color: var(--primary);
      margin-bottom: var(--space-lg);
    }
    
    .recording-timer.active {
      color: var(--error);
    }
    
    .recording-status {
      font-size: var(--font-size-md);
      color: var(--text-secondary);
    }
    
    .audio-visualizer {
      height: 100px;
      background: var(--gradient-subtle);
      border-radius: var(--border-radius-lg);
      margin: var(--space-xl) auto;
      max-width: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: var(--space-md);
    }
    
    .audio-visualizer.hidden {
      display: none;
    }
    
    .visualizer-bar {
      width: 4px;
      background: var(--primary);
      border-radius: 2px;
      transition: height 0.1s;
    }
    
    /* PROGRESS */
    .upload-progress {
      margin-top: var(--space-xl);
    }
    
    .upload-progress.hidden {
      display: none;
    }
    
    .progress-text {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin-bottom: var(--space-sm);
    }
    
    .progress-percentage {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      color: var(--primary);
      margin-bottom: var(--space-sm);
    }
  </style>
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="page-header">
      <button class="btn btn-ghost mb-md" onclick="window.location.href='./app.html'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        Retour au Dashboard
      </button>
      <h1>Nouvelle Consultation</h1>
      <p>Enregistrez en direct ou importez un fichier audio</p>
    </div>
    
    <!-- MODE SELECTOR -->
    <div class="mode-selector">
      <div class="mode-card active" id="modeUpload" onclick="selectMode('upload')">
        <div class="mode-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        </div>
        <h3 class="mode-title">Upload Audio</h3>
        <p class="mode-desc">Importer un fichier audio existant (MP3, WAV, M4A...)</p>
      </div>
      
      <div class="mode-card" id="modeRecord" onclick="selectMode('record')">
        <div class="mode-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="22"></line>
          </svg>
        </div>
        <h3 class="mode-title">Enregistrement Direct</h3>
        <p class="mode-desc">Enregistrer en direct avec votre microphone</p>
      </div>
    </div>
    
    <!-- FORM INFORMATIONS -->
    <div class="form-section">
      <h2 class="mb-lg">Informations de la consultation</h2>
      
      <form id="consultationForm">
        <div class="input-group">
          <label class="input-label">Titre de la consultation <span class="required">*</span></label>
          <input type="text" id="consultationTitle" class="input" placeholder="Ex: Consultation Mr Dupont" required>
        </div>
        
        <div class="input-group">
          <label class="input-label">Type de consultation</label>
          <select id="consultationType" class="input">
            <option value="Premi√®re consultation">Premi√®re consultation</option>
            <option value="Suivi">Suivi</option>
            <option value="Bilan">Bilan</option>
            <option value="Urgence">Urgence</option>
            <option value="R√©√©ducation">R√©√©ducation</option>
            <option value="√âvaluation">√âvaluation</option>
            <option value="Autre">Autre</option>
          </select>
        </div>
        
        <div class="input-group">
          <label class="input-label">Nom du patient (optionnel)</label>
          <input type="text" id="patientName" class="input" placeholder="Ex: Jean Dupont">
          <small class="input-help">Les donn√©es seront anonymis√©es dans la base</small>
        </div>
        
        <div class="input-group">
          <label class="input-label">Objectif de la consultation (optionnel)</label>
          <textarea id="consultationObjective" class="input" rows="3" placeholder="Ex: √âvaluation douleur lombaire..."></textarea>
        </div>
      </form>
    </div>
    
    <!-- UPLOAD SECTION -->
    <div class="form-section" id="uploadSection">
      <h2 class="mb-lg">Upload du fichier audio</h2>
      
      <div class="upload-zone" id="uploadZone" onclick="document.getElementById('audioFile').click()">
        <div class="upload-icon">üéµ</div>
        <div class="upload-text">
          <h3>Glissez-d√©posez votre fichier</h3>
          <p>ou cliquez pour s√©lectionner (MP3, WAV, M4A, OGG - Max 50 MB)</p>
        </div>
        <button type="button" class="btn btn-primary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          S√©lectionner un fichier
        </button>
        <input type="file" id="audioFile" accept="audio/*,.mp3,.wav,.m4a,.ogg" style="display: none;">
      </div>
      
      <div class="file-info hidden" id="fileInfo">
        <div class="file-details">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18V5l12-2v13"></path>
            <circle cx="6" cy="18" r="3"></circle>
            <circle cx="18" cy="16" r="3"></circle>
          </svg>
          <div>
            <div id="fileName" style="font-weight: 600;">fichier.mp3</div>
            <div id="fileSize" style="font-size: 14px; color: var(--text-secondary);">0 MB</div>
          </div>
        </div>
        <button type="button" class="btn btn-ghost btn-sm" onclick="removeFile()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Retirer
        </button>
      </div>
      
      <div class="upload-progress hidden" id="uploadProgress">
        <div class="progress-text">Upload et traitement en cours...</div>
        <div class="progress-percentage" id="progressPercentage">0%</div>
        <div class="progress">
          <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
        </div>
        <div class="progress-text" id="progressMessage">Pr√©paration...</div>
      </div>
      
      <button type="button" class="btn btn-primary btn-full btn-lg" id="btnUploadSubmit" onclick="submitConsultation()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Cr√©er la consultation
      </button>
    </div>
    
    <!-- RECORD SECTION -->
    <div class="form-section hidden" id="recordSection">
      <h2 class="mb-lg">Enregistrement audio</h2>
      
      <div class="recorder-zone">
        <button type="button" class="recorder-button" id="recordButton" onclick="toggleRecording()">
          <svg id="recordIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
          </svg>
          <svg id="stopIcon" style="display: none;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="6" y="6" width="12" height="12"></rect>
          </svg>
        </button>
        
        <div class="recording-timer" id="recordingTimer">00:00</div>
        <div class="recording-status" id="recordingStatus">Cliquez pour commencer l'enregistrement</div>
        
        <div class="audio-visualizer hidden" id="audioVisualizer">
          <!-- Barres g√©n√©r√©es dynamiquement -->
        </div>
      </div>
      
      <div class="upload-progress hidden" id="recordProgress">
        <div class="progress-text">Traitement en cours...</div>
        <div class="progress-percentage" id="recordProgressPercentage">0%</div>
        <div class="progress">
          <div class="progress-bar" id="recordProgressBar" style="width: 0%;"></div>
        </div>
        <div class="progress-text" id="recordProgressMessage">Pr√©paration...</div>
      </div>
      
      <button type="button" class="btn btn-primary btn-full btn-lg hidden" id="btnRecordSubmit" onclick="submitRecording()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Cr√©er la consultation
      </button>
    </div>
  </div>
  
  <!-- Scripts -->
  <script src="js/config.js"></script>
  <script src="js/supabase-client.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/consultations.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/recorder.js"></script>
  <script src="js/api.js"></script>
  
  <script>
    let selectedMode = 'upload';
    let selectedFile = null;
    let audioRecorder = null;
    let recordedBlob = null;
    let recordingStartTime = null;
    let timerInterval = null;
    
    // V√©rifier auth
    document.addEventListener('DOMContentLoaded', async () => {
      await requireAuth();
      initDragDrop();
      initFileInput();
      createVisualizer();
    });
    
    // === MODE SELECTION ===
    function selectMode(mode) {
      selectedMode = mode;
      
      // Update cards
      document.getElementById('modeUpload').classList.toggle('active', mode === 'upload');
      document.getElementById('modeRecord').classList.toggle('active', mode === 'record');
      
      // Show/hide sections
      document.getElementById('uploadSection').classList.toggle('hidden', mode !== 'upload');
      document.getElementById('recordSection').classList.toggle('hidden', mode !== 'record');
    }
    
    // === DRAG & DROP ===
    function initDragDrop() {
      const zone = document.getElementById('uploadZone');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        zone.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        zone.addEventListener(eventName, () => zone.classList.add('drag-over'), false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        zone.addEventListener(eventName, () => zone.classList.remove('drag-over'), false);
      });
      
      zone.addEventListener('drop', handleDrop, false);
    }
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length > 0) {
        handleFileSelect(files[0]);
      }
    }
    
    // === FILE INPUT ===
    function initFileInput() {
      document.getElementById('audioFile').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });
    }
    
    function handleFileSelect(file) {
      // Validation
      if (!file.type.startsWith('audio/')) {
        alert('Veuillez s√©lectionner un fichier audio');
        return;
      }
      
      if (file.size > CONFIG.MAX_FILE_SIZE_AUDIO) {
        alert(`Fichier trop volumineux (max ${formatFileSize(CONFIG.MAX_FILE_SIZE_AUDIO)})`);
        return;
      }
      
      selectedFile = file;
      
      // Afficher les infos
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
      document.getElementById('fileInfo').classList.remove('hidden');
      document.getElementById('uploadZone').style.display = 'none';
    }
    
    function removeFile() {
      selectedFile = null;
      document.getElementById('fileInfo').classList.add('hidden');
      document.getElementById('uploadZone').style.display = 'block';
      document.getElementById('audioFile').value = '';
    }
    
    // === RECORDING ===
    async function toggleRecording() {
      if (!audioRecorder || !audioRecorder.isRecording) {
        await startRecording();
      } else {
        await stopRecording();
      }
    }
    
    async function startRecording() {
      try {
        // Initialiser le recorder
        if (!audioRecorder) {
          audioRecorder = new AudioRecorder();
          const initResult = await audioRecorder.initialize();
          if (!initResult.success) {
            alert(initResult.error);
            return;
          }
        }
        
        // D√©marrer
        audioRecorder.start();
        recordingStartTime = Date.now();
        
        // UI
        document.getElementById('recordButton').classList.add('recording');
        document.getElementById('recordIcon').style.display = 'none';
        document.getElementById('stopIcon').style.display = 'block';
        document.getElementById('recordingStatus').textContent = 'Enregistrement en cours...';
        document.getElementById('recordingTimer').classList.add('active');
        document.getElementById('audioVisualizer').classList.remove('hidden');
        
        // Timer
        timerInterval = setInterval(updateTimer, 1000);
        
      } catch (error) {
        console.error('Erreur start recording:', error);
        alert('Erreur lors du d√©marrage de l\'enregistrement');
      }
    }
    
    async function stopRecording() {
      try {
        const result = await audioRecorder.stop();
        
        if (result.success) {
          recordedBlob = result.audioBlob;
          
          // UI
          document.getElementById('recordButton').classList.remove('recording');
          document.getElementById('recordIcon').style.display = 'block';
          document.getElementById('stopIcon').style.display = 'none';
          document.getElementById('recordingStatus').textContent = `Enregistrement termin√© (${formatDuration(result.duration)})`;
          document.getElementById('recordingTimer').classList.remove('active');
          document.getElementById('audioVisualizer').classList.add('hidden');
          document.getElementById('btnRecordSubmit').classList.remove('hidden');
          
          clearInterval(timerInterval);
        }
      } catch (error) {
        console.error('Erreur stop recording:', error);
        alert('Erreur lors de l\'arr√™t de l\'enregistrement');
      }
    }
    
    function updateTimer() {
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const seconds = (elapsed % 60).toString().padStart(2, '0');
      document.getElementById('recordingTimer').textContent = `${minutes}:${seconds}`;
    }
    
    function createVisualizer() {
      const visualizer = document.getElementById('audioVisualizer');
      for (let i = 0; i < 40; i++) {
        const bar = document.createElement('div');
        bar.className = 'visualizer-bar';
        bar.style.height = Math.random() * 50 + 20 + 'px';
        visualizer.appendChild(bar);
      }
      
      // Animate
      setInterval(() => {
        if (audioRecorder && audioRecorder.isRecording) {
          visualizer.querySelectorAll('.visualizer-bar').forEach(bar => {
            bar.style.height = Math.random() * 80 + 10 + 'px';
          });
        }
      }, 100);
    }
    
    // === SUBMIT ===
    async function submitConsultation() {
      if (!selectedFile) {
        alert('Veuillez s√©lectionner un fichier audio');
        return;
      }
      
      await processConsultation(selectedFile);
    }
    
    async function submitRecording() {
      if (!recordedBlob) {
        alert('Aucun enregistrement disponible');
        return;
      }
      
      // Convertir blob en fichier
      const file = new File([recordedBlob], `consultation-${Date.now()}.webm`, {
        type: recordedBlob.type
      });
      
      await processConsultation(file);
    }
    
    async function processConsultation(audioFile) {
      try {
        // R√©cup√©rer les infos du formulaire
        const title = document.getElementById('consultationTitle').value;
        const type = document.getElementById('consultationType').value;
        const patientName = document.getElementById('patientName').value;
        const objective = document.getElementById('consultationObjective').value;
        
        if (!title) {
          alert('Veuillez saisir un titre');
          return;
        }
        
        // Disable button
        const submitBtn = selectedMode === 'upload' ? 
          document.getElementById('btnUploadSubmit') : 
          document.getElementById('btnRecordSubmit');
        submitBtn.disabled = true;
        
        // Show progress
        const progressSection = selectedMode === 'upload' ? 
          document.getElementById('uploadProgress') : 
          document.getElementById('recordProgress');
        progressSection.classList.remove('hidden');
        
        // 1. Cr√©er la consultation dans la BDD
        updateProgress(10, 'Cr√©ation de la consultation...');
        
        const createResult = await createConsultation({
          title,
          type,
          patient_name: patientName,
          objective
        });
        
        if (!createResult.success) {
          throw new Error(createResult.error);
        }
        
        const consultationId = createResult.consultation.id;
        
        // 2. Upload + Processing complet
        const result = await processConsultationComplete(
          consultationId,
          audioFile,
          { title, type, patient_name: patientName, objective },
          (progress) => {
            updateProgress(progress.percentage, progress.message);
          }
        );
        
        if (result.success) {
          alert('Consultation cr√©√©e avec succ√®s !');
          window.location.href = `/consultation.html?id=${consultationId}`;
        } else {
          throw new Error(result.error);
        }
        
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur: ' + error.message);
        
        // Re-enable button
        const submitBtn = selectedMode === 'upload' ? 
          document.getElementById('btnUploadSubmit') : 
          document.getElementById('btnRecordSubmit');
        submitBtn.disabled = false;
      }
    }
    
    function updateProgress(percentage, message) {
      const progressPercentage = selectedMode === 'upload' ? 
        document.getElementById('progressPercentage') : 
        document.getElementById('recordProgressPercentage');
      const progressBar = selectedMode === 'upload' ? 
        document.getElementById('progressBar') : 
        document.getElementById('recordProgressBar');
      const progressMessage = selectedMode === 'upload' ? 
        document.getElementById('progressMessage') : 
        document.getElementById('recordProgressMessage');
      
      progressPercentage.textContent = Math.round(percentage) + '%';
      progressBar.style.width = percentage + '%';
      progressMessage.textContent = message;
    }
  </script>
</body>
</html>